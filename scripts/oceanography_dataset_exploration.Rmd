---
title: "Oceanography and satellite data for SOG"
author: "Patrick Pata"
date: '2023-01-10'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load libraries and files
```{r}
library(here)
source(here("functions/R_package_check.R"))
prepareLibrary()
source(here("functions/QOL_toolkit.R"))

theme_set(theme_bw())
set_here(path = "..")

# Taxonomy list for matching with trait dataset
taxonomy <- openxlsx::read.xlsx(here("table_inputs/taxonomy_table_20221122.xlsx"))

# Load net metadata 
load( here("data_outputs/net_metadata.RData") )

# Load SOG physics data
load( here("data_inputs/SOG_physics_data_2023_01_10.RData"))

# Load gridded satellite CHL data
load( here("data_inputs/SOG_satellite_acri_chl_2023_01_10.RData"))

# PolySet data frames for mapping the Strait of Georgia from the PBSmapping package
data(nepacLL)
data(nepacLLhigh) #higher resolution maps
colnames(nepacLLhigh) <- c("group", "POS", "lon", "lat") # rename columns
colnames(nepacLL) <- c("group", "POS", "lon", "lat")
```

# Distribution of CTD samples
```{r}
# Subset columns with CTD data
ctd.SOG <- physics.meta %>% 
  filter(!is.na(CTDKey))
  
# This is the high resolution base map for the SoG. Please change data = "nepacLL" if a lower resolution without some small islands is preferred.
SOGmap <- ggplot() + 
  geom_polygon(data=nepacLLhigh, aes(lon, lat, group=group), 
               fill="grey85", size=0.2, color="black") +
  coord_map(projection='mercator', 
            xlim = c(-126, -122), ylim = c(48, 51)) + 
  theme(axis.title = element_blank(), axis.text = element_blank()) +
  theme_classic() 

# Spatial distribution of samples. Note that there are multiple overlapping points and there are a few stations that are regularly sampled.
SOGmap +
  geom_point(data = ctd.SOG, aes(x = Longitude, y = Latitude,
                                       color = `Depth_Bottom.m.`)) +
  ggtitle("Distribution of CTD samples")


# Temporal distribution of samples
ggplot(data = ctd.SOG, aes(x = dayofyear, y = Year)) +
  geom_point(aes(color = Twilight)) +
  # Roughly mark seasons
  geom_vline(xintercept = c(32,120,212,304), linetype="dotted", color = "blue")

```

# TODO: contents of the data files

# Time series of ctd data
```{r}

```



# Calculating the average chlorophyll time series from gridded satellite data
```{r}
colnames(satellite.chl.grid)

SOGmap +
  geom_point(data = distinct(satellite.chl.grid, lon, lat), 
             aes(x = lon, y = lat))

chl.timeseries <- satellite.chl.grid %>% 
  # The coverage of grid cells with chlorophyll data varies every month due to cloud cover. For calculating the SOG chlorophyll average, only include grid cells which are often sampled throughout the time series, set to an arbitrary threshold of N data points = 100.
  group_by(lon, lat) %>% 
  mutate(Ndata = sum(!is.na(chl))) %>% 
  ungroup() %>% 
  filter(Ndata >= 100) %>% 
  # Calculating the average chlorophyll for SOG. Also divide into northern and central SOG roughly at 49.5 degrees latitude.
  # overall average
  group_by(year, month) %>% 
  mutate(chla.sog = mean(chl, na.rm = T),
         chla.sog.sd = sd(chl, na.rm = T)) %>% 
  # regional average
  mutate(region = if_else(lat >= 49.5, "northern", "central")) %>% 
  group_by(year, month, region) %>% 
  mutate(chla.sog.region = mean(chl, na.rm = T),
         chla.sog.region.sd = sd(chl, na.rm = T)) %>% 
  ungroup() %>% 
  # summarise
  select(-c(lon,lat,chl,Ndata)) %>% 
  distinct() %>% 
  # create year.month variable for timeseries
  mutate(year.month = year + (month-1)/12)

# Plot the timeseries
# overall
ggplot(data = distinct(chl.timeseries, year.month, .keep_all = T ),
       aes(x = year.month, y = chla.sog)) +
  geom_point() +
  geom_line() 
  # scale_y_continuous(trans='log10') 

# per region
ggplot(data = chl.timeseries,
       aes(x = year.month, y = chla.sog.region,
           color = region)) +
  geom_point() 
  

```

# Anomally time series
For time series data, it is often interesting to look into the anomaly of a parameter relative to a climatological mean. Here we calculate the monthly climatology of chla in the SOG and then, calculate the anomaly time series.
```{r}
# Calculate the monthly climatology of the entire SOG
chl.timeseries <- chl.timeseries %>% 
  group_by(month) %>% 
  mutate(chla.sog.clim = mean(chla.sog, na.rm = T)) %>% 
  ungroup() %>% 
  # Calculate the anomaly time series
  mutate(chla.sog.anom = chla.sog - chla.sog.clim)

# Plot anomaly as bar plots relative to zero
ggplot(data = distinct(chl.timeseries, year.month, .keep_all = T ),
       aes(x = year.month, y = chla.sog.anom)) +
  geom_bar(stat = "identity")
```


